# 3. 云主机服务 {#3}

云主机是金山私有云平台提供的一种基础云计算服务，并提供对云主机的整个生命周期的管理。

云主机实例是通过虚拟化方式创建出来的虚拟机资源，它拥有自己独立的操作系统，包含了CPU、内存、操作系统、磁盘、带宽等最基础的服务器组件。一个实例就等同于一台虚拟机，您对所创建的实例可以随时登录进行使用和管理，并可以在实例上进行基本操作，如：迁移、创建镜像、创建快照、创建监控等。

操作权限说明如下：

| 角色名称 | 查看 | 创建/复制 | 编辑 | 删除 | 
| :--- | :--- | :--- | :--- | :--- |
| Admin | √ | √ | √ | √ |
| Serviceadmin | -- | -- | -- | -- |
| Maintenanceadmin | -- | -- | -- | -- |
| Owner | √ | √ | √ | √ |
| Member | √ | √ | √ | √ |

以下将以Admin权限举例描述。

主要功能列表如下：

| 操作 | 描述 |
| :--- | :--- |
| 创建云主机 | 前置条件：有虚拟网络可选<br/>若没有，请先创建虚拟网络，参见`网络管理` |
| 运行、重启、停止 | -- |
| 更改云主机配置 | 关机状态下操作 |
| 迁移 | 在线迁移 |
| 创建镜像 | 关机状态下操作 |
| 创建快照 | 关机状态下操作 |
| 重置密码 | 关机状态下操作 |
| 创建、修改、删除监控 | -- |
| 删除云主机 | -- |

## 3.1 云主机管理 {#3-1}

### 3.1.1 创建云主机 {#3-1-1}

金山私有云平台提供向导的方式帮助用户进行云主机的创建。

#### 配置选项：

* 通用配置

| 选项 | 描述 |
| :--- | :--- |
| 主机名称 | 云主机的名字<br/>若系统为linux，则写入为操作系统的Hostname |
| 主机数量 | 默认为1<br/>若大于1将批量创建对应数量的同规格云主机 |
| 资源池（可自动分配） | 所创建云主机所属的资源池 |
| 系统镜像 | 包含通用镜像和自定义镜像 |
| 主机配置 | 包含CPU、内存、硬盘，可根据需求灵活定制 |
| 安全组 | 默认选择平台default安全组<br/>如需自定义参见`网络管理` |
| 选择网络 | 前置条件：有虚拟网络可选 |
| 选择网卡子网 | 可添加扩展网卡，上限为5块 |

* 可选配置

| 选项 | 描述 |
| :--- | :--- |
| 登录方式 | 默认为密码登录<br/>勾选后采用证书登录(SSH密钥) |
| 主机组 | 选择后云平台调度系统会将此主机组内的云主机分布于不同的物理主机 |
| 选择GPU | 为云主机增加GPU<br/>包括GPU的型号、数量及物理机的选择 |

#### 创建云主机实例步骤：

1. 登录金山私有云平台，点击左侧导航条中的『云主机』 -> 『云主机管理』，在右侧云主机管理页面，点击『创建云主机』。
2. 第一步：基本配置

![image](/assets/创建云主机表单-1.png)

3. 第二步：选择GPU（可选）

![](/assets/创建云主机表单-2.png)

4. 第三步：选择镜像

![](/assets/创建云主机表单-3.png)

5. 第四步：主机配置

![](/assets/创建云主机表单-4.png)

6. 第五步：网络设置

![](/assets/创建云主机表单-5.png)

7. 点击『创建』按钮，完成创建云主机流程。所创建实例将在『云主机列表』中显示，用户可对云主机进行更多操作。

### 3.1.2 查看云主机 {#3-1-2}

#### 列表查看

登录金山私有云平台，点击左侧导航条中的『云主机』 -> 『云主机管理』。

右侧云主机管理主界面会以列表的方式列出在当前项目下的所有云主机。

页面的右上角列出对云主机的三项基本操作『开机』、『关机』和『创建』方便用户对云主机的快捷操作，『更多操作』收录了云主机相关的其他操作。 

在云主机列表中每一行显示云主机的相关信息包括名称，状态，IP地址，监控状态，操作系统类型，所属网络区域，所属资源池，云主机的创建时间（支持按创建时间对云主机进行正向或逆向排序），以及云主机的所属项目和用户。

#### 详情查看

点击指定的云主机名字会进入云主机的详细页面，包括云主机的基本信息、磁盘管理、监控。在页面右上角可以进行主机的开/关机和重启操作。为方便理解，这里选上一步新建的虚机『VM-test』。

![](/assets/云主机-详情-基本信息.png)

##### 基本信息

基本信息页面分为基本信息和网络信息两部分。

- 基本信息左侧一栏显示当前云主机的名称及UUID、云主机位置信息（资源池和物理机节点）、创建时间、状态和订单信息；右侧一栏显示当前云主机绑定证书、所属主机组、镜像信息、和云主机规格（CPU、内存、磁盘等），并可以打开控制台。右上角『更多操作』按钮可对当前云主机进行相关操作。

- 网络信息为云主机多网卡信息显示，可以进行网卡的添加和删除操作（单台云主机当前网络下做多可添加5块网卡）。并以列表形式分别显示不同网卡的固定IP、浮动IP、虚拟IP、所属网络、所属分区、关联子网和安全组。

##### 磁盘管理

磁盘管理页面显示此云主机拥有的所有磁盘信息（包括磁盘名称、状态、大小和创建时间）。选中某一特定磁盘可对其进行『创建快照』操作，快照可以保留某个时间点上的系统数据状态，用于数据备份及回滚操作。

##### 云主机监控

云主机监控页面显示此云主机各个监控项的实时监控信息，并且可以选择『1天』、『7天』不同时间类别的监控信息。

### 3.1.3 自定义镜像 {#3-1-3}

用户在创建云主机后可以登录云主机安装应用软件以及把业务应用部署到云主机上，此时用户可以通过金山私有云平台的制作自定义镜像功能把现有的云主机转换成镜像，方便以后直接用镜像进行新的云主机部署。*（注意，此功能要求云主机在关机状态。）*

#### 创建自定义镜像

1. 在『云主机管理』列表中选中云主机（或进入所选『云主机详情』页面），点击『更多操作』按钮，在操作列表中点击『创建镜像』。
2. 在弹出的对话框中输入镜像名称和描述。
3. 点击『确定』。

#### 查看自定义镜像

- 点击左侧导航『镜像』，在列表中会看到新建的镜像，此镜像状态为『已注册』。

- 点击左侧导航『云主机』，在云主机列表页点击『创建云主机』按钮，在第三部镜像选择列表中选择『自定义镜像』标签，此时用户可以选择新建的镜像进行新的云主机的创建，新建的云主机会包含用户自定义的云主机配置、软件及业务。

### 3.1.4 快照及回滚 {#3-1-4}

用户可以对运行了一段时间的云主机进行『创建快照』操作，快照可以保留某个时间点上的系统数据状态，并且可以对指定快照做回滚操作使云主机回到备份时状态。

#### 创建快照注意事项：

1. 避开业务高峰。创建快照可能会轻微降低磁盘的性能，出现短暂瞬间变慢。
2. 实例状态最好为已关闭。
3. 手动创建的快照会一直保留。如不再需要，请手动删除。

#### 创建快照

1. 在『云主机管理』列表中选中云主机（或进入所选『云主机详情』页面），点击『更多操作』按钮，在操作列表中点击『创建快照』。
2. 在弹出对话框中输入快照名称和描述。对话框中会列出云主机使用的系统卷和已经挂载的数据卷。其中系统卷以`vm`+`云主机ID`+`bootvolume`命名。用户可以选择对所有卷或者指定卷进行备份。*（注意，至少要选择一块磁盘进行备份。）*
3. 选择后，点击『确定』，即完成创建。

#### 恢复快照

1. 在『云主机管理』列表中点击云主机名称，进入详细界面，选择『磁盘管理』标签，会看到云主机快照详细信息。页面会列出当前云主机使用的磁盘信息，选中任一磁盘，在列表下方以时间轴的方式显示当前所选磁盘的快照。
2. 选中时间轴中任一备份点，点击『恢复』按钮，即可对磁盘进行恢复操作。

## 3.2 主机组管理 {#3-2}

HA高可用主机组：此操作由云的租户创建和触发，创建云主机的时候选择『添加至主机组』，主机组就会尽力保证新建虚机位于不同的物理节点上，提高用户虚拟机的高可用性，避免单台物理机故障引发的用户服务损失。

以下图为例，当不开启HA主机组时，云主机的分布将不区分是否集中在一台物理主机上。如果选择了HA主机功能，那么属于此主机组的云主机将尽力而为地分布在不同的物理主机上。

![](/assets/HA主机组.png)

### 3.2.1 创建主机组 {#3-2-1}

- 创建主机组
 1. 登录金山私有云平台，点击左侧导航条中的『云主机』 -> 『主机组管理』。
 2. 在右侧主机组管理页面，点击『创建主机组』。
 3. 在弹出对话框中输入名称及描述。
 4. 点击『创建』按钮即完成创建。

- 创建云主机到主机组
在创建云主机时，选择『添加至主机组』即可。主机组将会尽力保证新建虚机位于不同的物理节点上。*（一个HA主机组可以包含多台云主机，但是一台云主机只能属于一个HA主机组。）*

云主机创建完成后，查看主机组页面，结果如下：如主机组HA-test-001，新建的10台云主机分别分配到3台不同的物理节点上。

![](/assets/云主机-HA主机组.png)

### 3.2.2 管理主机组 {#3-2-2}

管理主机组允许用户添加新的云主机到主机组或从主机组中删除已选云主机。

1. 登录金山私有云平台，点击左侧导航条中的『云主机』 -> 『主机组管理』。
2. 选中某个主机组，点击右侧『管理主机组』按钮。
3. 在弹出的『管理主机组』对话框中，勾选（即添加）新的云主机或取消选择（即删除）已选的云主机，对话框的右侧可查看当前主机组已勾选的云主机。
4. 最后点击『确定』按钮即可。

### 3.2.3 编辑主机组 {#3-2-3}

编辑主机组允许用户修改主机组名称及主机组描述。

1. 登录金山私有云平台，点击左侧导航条中的『云主机』 -> 『主机组管理』。
2. 选中某个主机组，点击名称右侧『编辑』按钮。
3. 在弹出的『更新主机组』对话框中输入需要更改的名称及描述。
4. 最后点击『确定』按钮即可。

### 3.2.4 删除主机组 {#3-2-4}

主机组删除后，将自动清除其与所有云主机的关联。

1. 登录金山私有云平台，点击左侧导航条中的『云主机』 -> 『主机组管理』。
2. 选中某个主机组，点击名称右侧『删除』按钮。
3. 在弹出的删除对话框中点击『删除』即可。 



