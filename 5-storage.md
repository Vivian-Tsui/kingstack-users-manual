# 5. 云存储服务 {#5}

金山云私有云集群将底层的存储细节结构化展示给用户，在用户控制台界面实现存储后端的灵活安装、配置、添加及管理。且相关配置不依赖于配置文件，能够实现水平扩展。 存储的安装过程充分自动化，不需要手动操作。

存储具体分为卷管理及存储管理两大块。卷管理位于“存储”模块，包括但不限于卷的`QOS`及`IOPS`的配置等，支持卷类型的创建，卷的创建、挂载、卸载、扩展以及共享盘的多挂载。

存储管理位于『管理』->『存储管理』模块，仅Admin和Seviceadmin有操作权限，主要包含存储介质的自发现、存储磁盘元信息的展示、存储的创建、扩容等，具体功能模块分为：探测集群磁盘，探测物理机磁盘，存储集群的创建、编辑、扩容、删除。

金山私有云整个云存储服务的原理结构图如下：
1. 从底层物理机集群探测出硬件磁盘列表。
2. 创建存储集群，并为之绑定物理磁盘（从1中探测出的磁盘列表中选择）
3. 基于存储集群创建卷类型，存储集群会根据卷类型提供卷服务。卷类型是用来设定卷的读写速率和吞吐量。
4. 创建卷的时候选择卷类型，接受存储集群提供的卷服务。

![](/assets/存储服务原理结构图.png)

## 5.1 卷管理 {#5-1}

登录金山私有云平台，点击左侧导航条中的『存储』->『卷管理』就会看到当前项目下的卷管理列表。

卷包括两类，一类是在创建云主机时系统自建的系统卷：命名规则为`vm-`+`云主机	ID`+`bootvolume`，此类卷是无法删除的，只能直接删除云主机。另一类是用户自建卷，这类卷主要是以数据卷的方式挂载到云主机上，其中共享盘支持多挂载。

操作权限说明如下：

| 角色名称 | 卷类型 | 卷管理 | 快照管理 |
| :--- | :--- | :--- | :--- |
| Admin | √ | √ | √ | 
| Serviceadmin | -- | -- | -- |
| Maintenanceadmin | √ | √ | √ |
| Owner | -- | √ | √ | 
| Member | -- | √ | √ | 

以下将以Admin权限举例描述。

### 5.1.1 创建卷 {#5-1-1}

#### 创建卷实例步骤

用户可以通过控制台向导创建卷。

1. 登录金山私有云平台，点击左侧导航条中的『存储』 -> 『卷管理』，在右侧卷管理页面，点击『创建卷』。
2. 在弹出的『创建卷』对话框中输入卷名称、卷数量、卷描述、选择数据来源，同时选择磁盘类型、卷类型，然后设置卷大小。最后点击创建即可。

![](/assets/创建卷.png)

#### 配置选项

| 选项 | 描述 |
| :--- | :--- |
| 卷名称 | 卷的名字 |
| 卷数量 | 默认填写1，上限为20 |
| 描述 | 卷的描述 |
| 数据来源 | 目前支持3种数据来源：<br/>1.『无源，卷是空的』—— 创建一个新的卷；<br/>2. 『快照』—— 基于一个快照创建一个同样的卷；<br/>3. 『卷』—— 基于一个已有的卷创建一个同样的卷。<br/>注意：如果是基于快照或卷创建，新建卷大小不得小于原有快照或卷。 |
| 磁盘类型 | 与卷类型保持一致 |
| 卷类型 | 用来设定卷的读写速率和吞吐量<br/>注意：管理员新建的卷类型绑定到一个存储集群后，需要去『管理』->『产品管理』页面创建并生成产品后，用户创建卷的时候才能看到新建的卷类型。|
| 卷大小 | 可按实际需求自定义卷大小（范围：1~16384G） |
| 多主机挂载 | 开启多主机挂载的卷为共享卷（最多同时挂载到5台云主机上） |

### 5.1.2 查看卷 {#5-1-2}

#### 列表查看

登录金山私有云平台，点击左侧导航条中的『存储』 -> 『卷管理』。

在右侧卷管理页面会以列表的方式列出在当前项目下的所有卷。

![](/assets/卷列表.png)

在卷管理列表中每一行显示卷的相关信息包括名称，卷大小，磁盘类型，状态，链接状态，卷的创建时间（支持按创建时间对主机进行正向或逆向排序），以及卷的所属项目和用户。在该页面，可根据卷的名称、类型、创建时间和所属项目、用户等信息进行卷的搜索查询。

- 状态：表示卷状态，主要有两种『正在使用』即已挂载到云主机，『可用』表示未挂载到任何云主机。
- 连接状态：显示卷挂载到云主机的具体目录。

在该页面列表中，可以对卷进行『扩展』、『删除』、『挂载/卸载主机』操作。

| 操作 | 描述 | 注意事项 |
| :--- | :--- | :--- |
| 扩展卷 | 为指定卷进行扩容 | 仅状态为『可用』的卷可扩展 |
| 删除卷 | 删除指定卷 | 系统卷无法删除，只能直接删除云主机 |
| 挂载主机 | 将指定卷挂载到某个选定的主机上 | 仅状态为『可用』的卷可扩展<br/>共享卷最多同时挂载5台主机 |
| 卸载主机 | 将指定卷从某主机上解除挂载 | 系统卷不可卸载 |

#### 详情查看

点击指定卷的名称会进入卷的详细页面，包括卷的基本信息、快照。

![](/assets/存储-卷详情.png)

- 基本信息 —— 展示卷的基本属性和挂载主机的信息。可以对卷进行『扩展』、『删除』、『挂载/卸载主机』操作。
- 快照 —— 当前卷的所有快照。支持『创建快照』、『删除快照』、『回滚』操作。

## 5.2 卷类型 {#5-2}

登录金山私有云平台，点击左侧导航条中的『存储』 -> 『卷类型』。

在右侧卷类型页面会以列表的方式列出在当前项目下的所有卷类型。

![](/assets/卷类型.png)

### 5.2.1 创建/删除卷类型 {#5-2-1}

#### 创建卷类型

用户可以通过控制台向导创建卷类型。

1. 登录金山私有云平台，点击左侧导航条中的『存储』 -> 『卷类型』，在右侧卷类型页面，点击『创建卷类型』。
2. 在弹出的『创建卷类型』对话框中输入卷类型的名称，并设定卷的读速率、写速率和吞吐量。最后点击创建即可。

![](/assets/创建卷类型.png)

#### 删除卷类型

删除卷类型的前提为卷类型处于『未使用』状态。

### 5.2.2 关联/解除关联存储集群 {#5-2-2}

卷类型创建成功后会弹出『关联存储集群』提示，点击『立即关联』按钮，弹出关联弹窗进行相应操作。如没有及时关联，则可以在卷类型列表操作中进行关联。

新建的卷点击右侧『关联存储集群』，从下拉列表中选择一个存储集群，最后点击『确定』即可。（解除关联操作同上。）

![](/assets/关联提示.png)

![](/assets/关联存储集群.png)

### 5.2.3 为卷类型创建产品 {#5-2-3}

管理员新建的卷类型绑定到一个存储集群后，需要去『管理』->『产品管理』页面创建并生成产品后，用户创建卷的时候才能看到新建的卷类型。

点击左侧导航栏『管理』->『产品管理』，在右侧页面点击『创建产品』按钮，在弹出的对话框中输入产品名称、产品描述，产品类型在下拉列表中选择『磁盘』，然后选择资费模板（详见7.5.2资费模板），选定已经新建的卷类型，勾选开放售卖，最后点击『确定』，即为新建的卷类型创建产品。

## 5.3 快照管理 {#5-3}

登录金山私有云平台，点击左侧导航条中的『存储』 -> 『快照管理』。

在右侧快照管理页面会以列表的方式列出在当前项目下的所有卷的快照。列表包括快照的名称、描述、状态、快照大小、创建时间以及快照所属的卷、项目和用户。并可以在该页面，根据快照的名称、所属卷、状态及创建时间对快照进行搜索查询。














