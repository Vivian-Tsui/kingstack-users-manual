# 10. 监控服务 {#10}

金山私有云监控服务提供对云主机、物理机和交换机的性能监控查看和服务监控查看。

## 10.1 监控模板 {#10-1}

监控模版是指某种云资源的监控项目集合。比如云主机的监控模版可以是CPU使用率、内存使用率、网卡流量、磁盘I/O的监控项集合。租户可以指定一个监控模板，并将此模板与对应的云资源绑定。之后云平台便将会根据模板中包含的监控项对此资源进行监控，采集监控数据并展示在控制台上。

此外，金山私有云平台向用户提供自建监控模板的功能，创建模板时可以选择一个或多个监控项，并且可以为每个选定的监控项设置报警规则，当资源使用率达到报警上限时就会向用户发送报警信息。模板分为两种类型public和private。public类型的模板对所有tenant可见，private类型的模板仅属于特定的tenant，tenant之间不可见。详细的操作权限说明如下：


| 角色名称 | 创建/复制 | 删除 | 更新 | 查看 |
| :--- | | :--- | | :--- | | :--- | | :---| 
| Admin<br>/Serviceadmin<br>/Maintenanceadmin | Public、Private | Public、Private | Public、Private | Public、Private |
| 项目 Owner | Private | Private | Private | Public、Private |
| 项目 Member | -- | -- | -- | Public、Private |

其他注意事项如下：

1. 为被监控主机（物理机、交换机或虚拟机）创建监控时，提供可选模板列表，并且仅能选择一个模板。
2. 修改监控模板的监控项、trigger时，联动修改主机的监控信息；删除模板时不影响关联的主机。
3. 金山私有云平台自带的默认监控模板包含全量监控项，但是不包含报警规则。并且只能对它复制，不能进行修改、删除等其他操作。

### 10.1.1 云主机监控模板 {#10-1-1}

1. 以admin或者maintenanceadmin账户登录控制台，建议采用后者。
2. 点击左侧导航条中的“监控 -> 监控模板”，默认选中“云主机”选项卡，可直接查看当前的云主机监控模板列表，点击监控模板名称可进入详情查看更多详细信息。

   ![](/assets/监控模板-云主机.png)

### 10.1.2 物理机监控模板 {#10-1-2}

1. 以admin或者maintenanceadmin账户登录控制台，点击左侧导航条中的“监控 -> 监控模板”，选中“物理机”选项卡，即可查看当前的物理机监控模板列表，点击监控模板名称可进入详情查看更多详细信息，admin/maintenanceadmin可查看和管理控制节点、计算节点、zabbix服务器和ironic物理机的监控模板。

    ![](/assets/物理机监控模板-admin.png)
          
2. member和owner账户登录时，只能看到ironic物理机的监控模板。
   
    ![](/assets/物理机监控模板-owner.png)

### 10.1.3 创建监控模板 {#10-1-3}

1. 以admin或者maintenanceadmin账户登录控制台，建议采用后者。
2. 点击左侧导航条中的“监控 -> 监控模板“，在云主机/物理机监控模板页面下，点击“创建监控模板”，在弹出的输入框中输入模板名称、描述、并勾选“设为Public模板”（不勾选则模板为private类型），创建云主机/物理机监控模板。

   ![](/assets/创建监控模板-Admin.png)

### 10.1.4 管理监控项 {#10-1-4}

1. 在云主机/物理机监控模板页面，选中某个监控模板，点击右侧的  ![](/assets/icon-more.png)  按钮，选择“管理监控项”。
2. 在弹出的页面中选择监控项，然后点击“确定”。

   ![](/assets/管理监控项弹窗.png)
   
### 10.1.5 设置报警规则 {#10-1-5}

1. 在云主机/物理机监控模板页面，选中某个监控模板，点击右侧的 ![](/assets/icon-more.png) 按钮，选择“设定报警规则”。
2. 在弹出的页面中设置报警规则。对每个监控项都可以设置报警规则，用户可以根据情况自行设定。当资源使用率达到报警上限及持续时间时就会向用户发送报警信息。
   
   ![](/assets/设置报警规则.png)
   
### 10.1.6 更多操作 {#10-1-6}

除管理监控项、设置报警规则外，每个监控模板的右侧还提供了更多其他操作的入口，包括编辑模板、删除模板、复制模板。

| 操作 | 对应按钮 | 前提条件 | 描述 |
| :--- | | :--- | | :--- | | :--- |
| 编辑模板 | ![](/assets/icon-edit.png) | -- | 修改监控模板的名称、描述信息、public/private类型 |
| 删除模板 | ![](/assets/icon-delete.png) | 监控模板上已经没有绑定的云资源 | 模板下有绑定的云资源时不允许删除 |
| 复制模板 | ![](/assets/icon-more.png) | 复制模板命名时不可与已有监控模板重名 | 复制模板时将复制已有模板的监控项和报警规则 |

## 10.2 告警接收管理 {#10-2}

金山私有云平台支持创建告警接收组，并向接收组里添加告警接收人，当资源使用率超过设定值，触发报警信息后，会向所绑告警接收组里的所有报警接收人发送报警信息。不同角色对告警接收组的操作不同：

| 角色名称 | 创建 | 删除 | 更新 | 查看 |
| :--- | | :--- | | :--- | | :--- | | :---| 
| Admin<br>/Serviceadmin<br>/Maintenanceadmin | Public、Private | Public、Private | Public、Private | Public、Private |
| 项目 Owner | Private | Private | Private | Public、Private |
| 项目 Member | -- | -- | -- | Public、Private |

### 10.2.1 创建接收组 {#10-2-1}

1. 以admin或者maintenanceadmin账户登录控制台，建议采用后者。
2. 点击左侧导航条中的“监控 -> 告警接收管理“，在右侧页面点击“创建接收组”，在弹出的输入框中输入接收组名称、描述、并勾选接收信息的方式，接收方式可选“邮件”或“短信”（必须选择一种接收方式）。
3. 如将接收组设为public， 则接收组对所有tenant可见， private类型的接收组则仅属于特定的tenant，tenant之间不可见。

   ![](/assets/创建接收组弹窗.png)
   
### 10.2.2 添加接收人 {#10-2-2}

在告警接收管理页面选中某一特定接收组，可向组内添加接收人。

点击“添加接收人”按钮，在弹出的输入框中输入接收人姓名、邮箱、手机（若创建接收组的时候接收方式没选“短信”则不用填写手机号码，同理，若接收方式没有选择“邮件”则无需填写邮箱）。

![](/assets/添加接收人弹窗.png)

添加接收人时，即可增加新用户，也可选择现有系统用户：填写接收人姓名时，将与已有的系统用户进行模糊匹配，列出与所输入姓名相匹配的系统用户，在下拉列表中选择某系统用户后，该用户的邮箱和手机信息将自动填充。

![](/assets/添加接收人-下拉匹配.png)

### 10.2.3 更多操作 {#10-2-3}

| 操作 | 对应按钮 | 前提条件 | 描述 |
| :--- | | :--- | | :--- | | :--- |
| 编辑接收人 | ![](/assets/icon-edit.png) | -- | 修改接收人的名称、邮箱和手机 |
| 删除接收人 | ![](/assets/icon-delete.png) | 接收人所在的告警接收组已经没有绑定的云资源 | 接收组下有绑定的云资源时不允许删除 |

## 10.3 告警过滤管理 {#10-3}

用户可登录控制台设定维护期和告警过滤规则，使得指定通知组在指定时间段内不接收某些告警信息。

维护期定义了一个时间段，目的是在这个时间段内，关联的告警规则如若触发报警，报警消息将不会发送。

告警过滤规则定义了一条过滤告警的规则，当这条规则被满足时，将不会发送报警消息。一条告警过滤规则包含四个要素：主机、报警规则、通知组、维护期，表示在维护期内，主机上指定的报警规则如果触发告警，报警消息不会发送给指定通知组的用户。 

维护期和告警过滤规则均分为public和private两种类型。public类型的维护期和告警过滤规则对所有tenant可见，private类型的维护期和告警过滤规则仅属于特定的tenant，不同tenant之间互不可见。详细的操作权限说明如下：

| 角色名称 | 创建/复制 | 删除 | 更新 | 查看 |
| :--- | | :--- | | :--- | | :--- | | :---| 
| Admin<br>/Serviceadmin<br>/Maintenanceadmin | Public、Private | Public、Private | Public、Private | Public、Private |
| 项目 Owner | Private | Private | Private | Public、Private |
| 项目 Member | -- | -- | -- | Public、Private |

### 10.3.1 维护期 {#10-3-1}

1. 以admin或者maintenanceadmin账户登录控制台，建议采用后者。
2. 点击左侧导航栏下的“监控->告警过滤管理”，选中“维护期”选项卡，即可查看当前的维护期列表，列表展示了维护期名称、类型、维护时间段、已关联过滤规则个数（点击下拉按钮可查看已关联过滤规则的名称，点击规则名称可打开过滤规则的详情页），以及维护期描述，更多信息则可点击维护期名称进入详情页查看。
3. 在列表中，可根据维护期类型（private、public）对维护期进行筛选。

   ![](/assets/维护期.png)

#### 10.3.1.1 创建维护期 {#10-3-1-1}

在维护期列表的右上角，点击“创建维护期”按钮将弹出创建维护期弹窗。创建维护期的过程分为两步进行，第一步填写维护期的基本信息，包括名称、描述、起始时间和结束时间，第二步设置一个或多个时间段。

第一步：填写基本信息

![](/assets/创建维护期-基本信息.png)

第二步：设置一个或多个时间段

![](/assets/创建维护期-设置时间段.png)

#### 10.3.1.2 修改时间段 {#10-3-1-2}

点击列表中某个维护期右侧对应的“修改时间段”操作，可在弹出窗口中修改或删除已有时间段，并新增新的时间段。

#### 10.3.1.3 更多操作 {#10-3-1-3}

| 操作 | 对应按钮 | 前提条件 | 描述 |
| :--- | | :--- | | :--- | | :--- |
| 编辑维护期 | ![](/assets/icon-edit.png) | -- | 修改维护期的名称、描述、起始时间、结束时间 |
| 删除维护期 | ![](/assets/icon-delete.png) | 维护期没有关联告警过滤规则 | 维护期如已关联了过滤规则，不允许删除 |

### 10.3.2 告警过滤规则 {#10-3-2}

1. 以admin或者maintenanceadmin账户登录控制台，建议采用后者。
2. 点击左侧导航栏下的“监控->告警过滤管理”，选中“告警过滤规则”选项卡，即可查看当前的告警过滤规则列表，列表展示了过滤规则名称、描述、维护期、维护主机类型、维护通知组个数（点击下拉按钮可查看已关联的通知组，点击通知组名称可打开通知组详情），以及规则类型，更多信息可点击过滤规则名称进入详情页查看。
3. 在列表中，可根据维护主机类型（云主机、计算节点、控制节点等）和规则类型（private、public）对告警过滤规则进行筛选。

  ![](/assets/告警过滤规则.png)

#### 10.3.2.1 创建告警过滤规则 {#10-3-2-1}

在告警过滤规则列表的右上角，点击“创建过滤规则”按钮将弹出告警过滤规则创建弹窗。创建告警过滤规则分四步完成：基本设置、主机设置、通知组设置、告警规则设置。

第一步：基本设置

首先填写告警过滤规则的名称、描述、维护期，并设置过滤规则是否为public属性。

![](/assets/创建告警过滤规则-基本设置.png)

第二步：主机设置

选择希望与告警过滤规则相关的主机，默认展示云主机列表，也可根据需求选择不同类型的主机，如计算节点。

![](/assets/创建告警过滤规则-主机设置.png)

第三步：通知组设置

选择不希望接收相关告警的通知组。

![](/assets/创建告警过滤规则-通知组设置.png)

第四步：告警规则设置

选择希望过滤掉的报警表达式，可选择适用于全部已选主机的某一类报警表达式也可选择仅适用于特定主机的报警表达式。

![](/assets/创建告警过滤规则-告警规则设置.png)

#### 10.3.2.2 修改关联主机 {#10-3-2-2}

点击列表各项右侧的 ![](/assets/icon-more.png) 按钮，在下拉菜单中点击“修改关联主机”操作，可在弹出窗口中修改与告警过滤规则相关联的主机。

#### 10.3.2.3 修改通知组 {#10-3-2-3}

点击列表各项右侧的 ![](/assets/icon-more.png) 按钮，在下拉菜单中点击“修改通知组”操作，可在弹出窗口中修改关联的通知组。

#### 10.3.2.4 修改报警规则 {#10-3-2-4}

点击列表各项右侧的 ![](/assets/icon-more.png) 按钮，在下拉菜单中点击“修改报警规则”操作，可在弹出窗口中修改关联的报警规则。

#### 10.3.2.5 更多操作 {#10-3-2-5}

| 操作 | 对应按钮 | 前提条件 | 描述 |
| :--- | | :--- | | :--- | | :--- |
| 编辑过滤规则 | ![](/assets/icon-edit.png) | -- | 修改告警过滤规则的名称、描述、维护期，以及是否为public |
| 删除过滤规则 | ![](/assets/icon-delete.png) | -- | 删除告警过滤规则后，规则将不再生效 |


## 10.4 控制节点监控（仅管理员） {#10-4}

管理员可登录控制台查看所有控制节点的性能监控信息和服务监控信息。

1. 以admin或者maintenanceadmin账户登录控制台，建议采用后者。
2. 点击左侧导航栏下的“监控->控制节点”，即可查看当前控制节点的性能监控信息、服务监控信息，以及相应的报警规则（如果该控制节点已是监控中状态）。点击右上角的控制节点名称可切换不同的控制节点。
3. 如控制节点尚未创建监控，则需先通过点击“创建监控”为控制节点创建监控。

   ![](/assets/未监控-控制节点.png)

   ![](/assets/创建监控弹窗.png)
   
4. 如已创建监控，可通过“修改监控”按钮更改监控模板和通知组，也可通过“停止监控”按钮停止监控该控制节点。

   ![](/assets/监控信息.png)

### 10.4.1 性能监控 {#10-4-1}

“性能监控”根据创建监控时所选的监控模板展示对当前控制节点的以下性能进行监控：资源使用率（内存使用率和CPU使用率）、磁盘IO（读写速率、IO平均时间等）、磁盘挂载点和网卡（网络流量）等。点击监控曲线上某一点，方框中显示该点所在位置的精确时间和监控项的具体值。除实时监控以外，点击右侧的“1天”、“7天”可分别查看最近一天和最近一周的监控数据。

### 10.4.2 服务监控 {#10-4-2}

“服务监控”展示当前控制节点所有服务的信息，包括服务名称、服务属性、服务状态、子服务个数和操作。点击“操作”下的“查看详情”可查看对应服务的详细信息。

### 10.4.3 报警规则 {#10-4-3}

“报警规则”展示了当前控制节点所适用的报警规则，每条报警规则均包括报警项及相应的报警条件。当监控项的资源使用率达到报警规则设定的使用率时会向所选告警接收组里的接收人发送报警信息。

## 10.5 交换机监控（仅管理员） {#10-4}

admin和maintenanceadmin可登录控制台查看“交换机”的监控信息。包括名称、厂商信息以及接口流量信息，接口丢包信息。

![](/assets/交换机监控.png)

## 10.6 云主机监控 {#10-5}

登录控制台，点击左侧导航条中的“云主机 -> 云主机管理“，在右侧页面选中某一云主机，点击右侧“更多操作->创建监控”，在弹出框中选择监控模板、通知组（此处可不添加通知组，也可添加多个通知组），点击“创建”按钮，则成功为云主机创建监控。监控项为所选监控模板里设定的监控项。当监控项的资源使用率达到报警规则设定的使用率时会向所选告警接收组里的接收人发送报警信息。

![](/assets/创建监控-云主机.png)







